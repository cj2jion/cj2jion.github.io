---
layout: post
title:  Netflow的介绍
date:   2017-02-23 
category: "学习"
---
<h2 id="tagline">寒假在家老师让我总结的Netflow的原理、功能及使用方法，不知道我后面会不会用到，先把总结写下来</h2>


<ol id="table">
    <li><a href="#section1">NetFlow的基本介绍</a>
        <ul>
            <li><a href="#section1-1">NetFlow</a></li>
            <li><a href="#section1-2">NetFlow的工作原理</a></li>
        </ul>
    </li>
    <li><a href="#section2">业务流程</a></li>
    <li><a href="#section3">使用方法（分为网流设备的配置和NetFlow流量收集器的配置）</a>
        <ul>
            <li><a href="#section3-1">V5和V8的通信机制</a></li>
            <li><a href="#section3-2">V9的通信机制</a></li>
            <li><a href="#section3-2">交换机上的配置</a></li>
        </ul>
    </li>
    <li><a href="#section4">NetFlow的功能</a></li>
    <li><a href="#section5">利用NetFlow技术进行互联网的安全管理</a></li>
</ol>


<h2 id="section1">一、NetFlow的基本介绍</h2>
<h3 id="section1-1">NetFlow</h3>
<p> （1）通过分析网络中不同Flow间的差别，可以发现判断任何两个IP数据包是否属于同一个Flow。实际上可以通过分析IP数据包的以下7个属性来实现：</p>
<ol>
    <li>源IP地址（Source IP address）</li>
    <li>目的IP地址（Destination IP address）</li>
    <li>源端口号（Source port number）</li>
    <li>目的端口号（Destination port number）</li>
    <li>协议类型（Protocol type）</li>
    <li>服务类型（Type of service）</li>
    <li>输入/输出接口（Input/Output interface）</li>
</ol>
<p>将路由器的所有数据包分成很多有以上信息的7字段值的单向IP数据流，称为网流（NetFlow）。流量信息是基于每个流做统计的。</p>
<p> （2）网流设备是通过IP数据包中的七元组信息来识别网流的。网流设备上有专门的缓存，用于暂存网流初步的统计数据。当网流设备配置了网流统计功能并启动了网流转发功能后，网流设备会周期性的把网流统计数据发出，网流收集器会接收这些数据并进行处理。</p>
<h3 id="section1-2">NetFlow的工作原理</h3>
<p>NetFlow利用标准的交换模式处理数据流的第一个IP包数据，生成NetFlow 缓存，随后同样的数据基于缓存信息在同一个数据流中进行传输，不再匹配相关的访问控制等策略，NetFlow缓存同时包含了随后数据流的统计信息。NetFlow有两个核心的组件：NetFlow缓存，存储IP流信息；NetFlow的数据导出或传输机制，NetFlow利用此机制将数据发送到网络管理采集器。</p>
<p>netflow的信息单元是flow。flow是一个单向的带有唯一标识字节组的传输流。基本的标识为以上所说七元组。当路由器接收到一个没有flow入口的数据包时，一个flow的结构将被初始化以保存其状态信息如：交换的字节数、IP地址、端口、自治区域等。随后所有满足这个flow结构的数据包都将增加flow结构的字节计数和包计数，直至这个flow中止并输出。</p>
<p>Netflow功能是在一个路由器内独立完成，它不涉及路由器之间的任何连接设置协议，也不要求对数据包本身或其它任何网络设备进行任何外部修改。Netflow交换中要创建一个信息高速缓存，第一个数据包到来时，路由器利用标准的快速交换处理信息包，同时生成一个Netflow高速缓存，随后到来的数据包即可以依据高速缓存信息被交换，对于所有活动信息流，在Netflow高速缓存中保留相应的信息流信息。当一定时间内没有相应的数据包通过，则结束这个数据流的交换和统计，并释放高速缓存，数据输出的条件在后续部分描述。 netflow中到期的flow被绑在UDP数据报中发出。</p>
<p>在V5的版本中最多30个flow录，V1中25个记录，V8中28个记录。至少每秒钟发一次flow。 虽然netflow只提供单向的流量统计。如果希望得到表现双向的统计数据，netflow提供了“canned”的SQL程序来获得一个IP地址对的流量统计数据。 典型的路由器netflow的资源占用率为8％～30％。一般情况下一个netflow收集器接收3－5个路由器的netflow输出。</p>
<h4>输出格式：</h4>
<p>NetFlow支持同时向两个管理服务器地址输出采集到的网络流量和流向统计信息，输出数据的方式有三种：</p>

<ol>
    <li>简单高效UDP传输协议方式（传统方式）。但由于采用了UDP协议，数据传输的可靠性是不保证的。</li>
    <li>SNMP MIB方式。管理服务器可以通过SNMP协议访问网络设备NetFlow MIB库中存储的数据流Top N统计结果。</li>
    <li>可靠的SCTP传输协议方式。利用SCTP传输协议，支持拥塞识别，重传和排队机制，确保NetFlow统计结果数据正确发送给上层管理服务器。</li>
</ol>

<h4>cache缓存空间</h4>
<p>图一，后面来放图</p>

<h4>在NetFlow中的两个关键组件：</h4>
<ol>
    <li>NetFlow Cache，主要描述流缓存(或者说源数据)如何存放在Cache中。
NetFlow缓存管理机制中包含一系列高度精细化算法，能够有效地判断一个报文是属于已存在Flow的一部分还是应该在缓存中产生一条新的Flow。这些算法也能动态更新缓存中Flow的信息，并且判断哪些Flow应该到期终止。
    </li>
    <li>NetFlow Export，数据流的输出机制，主要描述了数据流是如何输出并被分析器接收的。</li>
</ol>
<p>首先了解NetFlow Cache(缓存机制)。当缓存中的Flow到期后，就产生一个将Flow输出的动作。将超时的Flow信息以数据报文的方式输出，叫做“NetFlow Export”，这些输出的报文包含30条以上的Flow信息。这些NetFlow信息一般是无法识别的，需由专用收集器(Flow Collector)采集到并做出进一步分析，这些Flow Collector能够识别NetFlow的特殊格式。</p>

<h2 id="section2">二、业务流程</h2>
<p>图二</p>
<p>在预处理阶段，NetFlow可以首先根据网络管理的需要对特定级别的数据流进行过滤或对高速网络端口进行数据包抽样，这样可以在确保需要的管理信息被采集和统计的同时，减少网络设备的处理负荷，增加全系统的可扩展性。</p>
<p>在后处理阶段，NetFlow可以选择把采集到的数据流原始统计信息全部输出，由上层管理服务器统一接收后再进行数据的分类处理和汇总；也可以选择由网络设备自身对原始统计信息进行多种形式的数据汇聚，只把汇总后的统计结果发送给上层管理服务器。</p>

<h2 id="section3">三、使用方法（分为网流设备的配置和NetFlow流量收集器的配置）</h2>
<h3 id="section3-1">V5和V8的通信机制</h3>
<p>两者都是通过文本命令行形式进行的配置。NetFlow的数据输出要求先在路由器和交换机上定制NetFlow流输出，并选择输出流的版本、个数、缓冲区的大小等，配置相应 NetFlow流量收集器(FlowCollector)的IP地址、端口等信息。此时路由器或交换机即可以用户数据报协议(UDP)的方式向外发送流信息，然后在NetFlow FlowCollector端配置接收端口号，设置汇聚、过滤策略和流量文件存放目录、格式等。</p>

<h3 id="section3-2">V9的通信机制</h3>
<p>和以前版本最大区别就是V9的数据格式可以自定义，有很强的扩展性，描述一个连接的参数的数量可以自己定义，可多可少，而以前的版本的数据格式是固定的，如果用了某版本，即使其中很多字段不需要，在一个数据记录中同样要保留这些参数，使灵活性很差，导致想看的数据看不到，不想看的又必须看。V9采用周期性交互，需要通过协议配置进行模板指定。</p>
<p>网络设备在进行NetFlow V9格式的数据输出时会向上层管理服务器分别发送数据包模板和数据流纪录。数据包模板确定了后续发送的数据流纪录数据包的格式和长度，便于管理服务器对后续数据包的处理。同时为避免传输过程中出现丢包或错误，网络设备会定期重复发送数据包模板给上层管理服务器。</p>

<h3 id="section3-3">交换机上的配置</h3>
<p>下面归纳一下实施流量监控的步骤(以Cisco 6000系列交换机为例)：</p>
<ol>
    <li> 在Cisco 6509上配置NetFlow(或其他网络设备)，并输出到指定到Ossim采集器(IP)的固定UDP端口。
    </li>
    <li>采集器软件为Ossim系统的Flow-tool工具，该软件监听UDP端口，接收进入的NetFlow数据包并存储为特定格式。</li>
    <li>使用Nfsen等软件包中的工具对NetFlow源文件进行读取，转换成可读的ASICII格式，再用Ossim内的Perl程序对NetFlow进行分析和规范格式的操作，并将读取的NetFlow信息存储入Ossim数据库中。</li>
    <li>依据蠕虫和DDOS攻击等异常报文的流量特征，在分析程序中预设各种触发条件，定时运行，从中发现满足这些条件的Flow。</li>
    <li> 将分析结果在Web客户端中展示，或者通过E-mail、短信等接口发送。也可以通过与设备联动的方式，采用ACL对设备进行自动配置，等攻击流消退后再自动取消ACL。
除了OSSIM之外，还有些商业软件都提供了很好的分析工具，例如Solarwinds NetFlow Traffic Analysis 和Manage Engine NetFlow Analyzer
    </li>
</ol>


<h2 id="section4">四、NetFlow功能</h2>
<p>采用 NetFlow 技术可以监测网络上的 IP 流信息，采集到的 NetFlow 流量信息可以帮助客户实现虚拟化业务流量计费、网络规划、网络监控、用户监控和分析等，具体表现为：</p>
<ol>
   
    <li>计费：NetFlow 为基于资源（如线路、带宽、时段等）占用情况的计费提供了精细的数据。ISP（Internet Service Provider，互联网服务提供商）可以利用这些信息来实行灵活的计费策略，如基于时间、带宽、应用、服务质量等。企业客户可以使用这些信息计算部门费用或分配成本，以便有效利用资源。</li>
    <li>网络规划：NetFlow 可以为网络管理工具提供关键信息，以便优化网络设计和规划，实现以最小的网络运营成本达到最佳的网络性能和可靠性。</li>
    <li>网络监控：通过在业务环境中部署 NetFlow，对连接虚拟交换网络的虚拟机接口进行实时的流量监控，可以分析各种业务占用出口带宽的情况。网管人员可以根据这些信息判断网络的运行情况，尽早发现不合理的网络结构或是网络中的性能瓶颈，方便网管人员规划和分配网络资源。</li>
    <li>用户监控和分析：通过 NetFlow 技术可以使网络管理者轻松获取用户使用虚拟网络和应用资源的详细情况，进而高效地规划以及分配网络资源，并保障网络的安全运行。</li>
</ol>

<h2 id="section5">五、利用NetFlow技术进行互联网的安全管理</h2>
<p>利用NetFlow技术，运营商管理员主要可以实现对网络异常通信的检测，重点防范DDoS攻击和大范围的蠕虫病毒发作，建议的处理流程如下：</p>
<ol>
   
    <li>管理准备阶段：预先在网络设备上启动NetFlow，并把NetFlow采集到的网络通信流量和流向数据发送给运营商安全管理中心部署的相应NetFlow分析和安全管理系统。
管理系统通过分析日常NetFlow采集到的统计数据，可以事先掌握网络的流量分布状况以及全网通信的正常基线，并以此为依据为日后可能出现的通信异常进行评估。
</li>
    <li>攻击发现和识别阶段：由于NetFlow管理代理是内嵌在网络设备中的，当网络流量突然出现异常时，NetFlow可以迅速做出反应。异常通信的流量和流向统计信息可以被实时汇总到管理中心的安全管理系统。通过分析，管理系统可以区分出异常流量的具体属性，包括异常出现的时刻，通信的来源地址和目的地地址的分布，占用端口的分布状况，通信流量的峰值，持续的时间等等。</li>
    <li>攻击确认和分类阶段：根据分析出的异常通信的具体属性，以及与网络通信正常基线的比对，管理员可以快速定性出现的通信异常是否为网络安全攻击、确定安全攻击的类型和评估本次攻击的危险程度及可能造成的影响范围。对会造成大范围网络影响甚至业务瘫痪的恶性安全攻击需要进行实时告警。</li>
    <li>攻击追踪阶段：在确定安全攻击的类型和危险级别后，为便于在源头阻塞安全攻击，需要为进一步澄清安全攻击出现的原始来源以及除主要攻击源外是否还存在其它安全危险来源。管理员可以利用管理系统对NetFlow采集到的原始攻击数据包的具体特性进行察看，查找最先出现攻击的数据源，以及随时间的发展是否还有其它新的安全攻击数据源的出现。</li>
    <li>处理阶段：在确认了所有主要安全攻击的来源后，管理员可根据本次所受攻击的特点采用相应技术手段实施事故应急处理，如为出现攻击的网络端口配置入向或出向的访问控制列表，对特定类型通信流量进行限速等。通过这些技术措施可以对网络安全攻击流量进行阻断，防止其对大范围网络的运行造成影响。</li>
    <li>后续监视阶段：在安全攻击被阻断后，全网所有设备中的NetFlow管理代理还会继续对网络通信流量进行采集和检测，汇总到管理系统的统计数据可以评估是否所有攻击都已经被屏蔽，并持续监视是否还有新的安全攻击的出现。</li>
</ol>
<p>为更好地帮助电信运营商利用思科的NetFlow技术对互联网进行有效的安全管理，思科公司还与多家业界知名的安全管理系统开发商达成了技术合作，合作利用NetFlow技术开发电信级的网络安全管理系统。现在市场上支持思科NetFlow技术的网络安全管理系统有多种，如思科公司自己提供的Cisco Info Center管理系统，以及如Arbor Networks公司，Mazu Networks公司，Adlex公司等多家第三方厂商提供的安全管理软件。</p>













